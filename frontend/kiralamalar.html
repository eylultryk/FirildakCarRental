<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Fırıldak Kiralama Geçmişi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4">Kiralama Geçmişi</h2>

  <div class="card p-4 shadow-sm mb-4">
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Kullanıcı ID</label>
        <input type="number" class="form-control" id="kullaniciId">
      </div>
      <div class="col-md-4">
        <label class="form-label">Başlangıç Tarihi</label>
        <input type="date" class="form-control" id="filtreBaslangic">
      </div>
      <div class="col-md-4">
        <label class="form-label">Bitiş Tarihi</label>
        <input type="date" class="form-control" id="filtreBitis">
      </div>
    </div>
    <button class="btn btn-primary w-100" onclick="kiralamalariGetir()">Geçmişi Göster</button>
  </div>

  <table class="table table-bordered shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Araç</th>
        <th>Başlangıç</th>
        <th>Bitiş</th>
        <th>Ücret</th>
        <th>İade</th>
      </tr>
    </thead>
    <tbody id="gecmis-body"></tbody>
  </table>

  <div id="mesaj" class="text-center mt-3 fw-bold"></div>
</div>

<script>
  const API_URL = "https://localhost:7058"; 

  async function kiralamalariGetir() {
    const kullaniciId = document.getElementById("kullaniciId").value;
    const baslangic = document.getElementById("filtreBaslangic").value;
    const bitis = document.getElementById("filtreBitis").value;

    if (!kullaniciId) {
      document.getElementById("mesaj").innerText = "Kullanıcı ID girmeniz gerekiyor.";
      document.getElementById("mesaj").className = "text-danger";
      return;
    }

    let url = `${API_URL}/api/kiralama/kullanici/${kullaniciId}`;
    const queryParams = [];

    if (baslangic) queryParams.push(`baslangic=${baslangic}`);
    if (bitis) queryParams.push(`bitis=${bitis}`);
    if (queryParams.length > 0) url += `?${queryParams.join("&")}`;

    const response = await fetch(url);
    const data = await response.json();

    const tbody = document.getElementById("gecmis-body");
    tbody.innerHTML = "";
    document.getElementById("mesaj").innerText = "";

    if (data.length === 0) {
      document.getElementById("mesaj").innerText = "Kayıt bulunamadı.";
      document.getElementById("mesaj").className = "text-warning";
      return;
    }

    data.forEach(item => {
      tbody.innerHTML += `
        <tr>
          <td>${item.id}</td>
          <td>${item.arac}</td>
          <td>${item.baslangicTarihi.split("T")[0]}</td>
          <td>${item.bitisTarihi.split("T")[0]}</td>
          <td>${item.toplamUcret} ₺</td>
          <td><button class="btn btn-sm btn-danger" onclick="aracIade(${item.id})">İade Et</button></td>
        </tr>
      `;
    });
  }

  async function aracIade(kiralamaId) {
    const response = await fetch(`${API_URL}/api/kiralama/iade/${kiralamaId}`, {
      method: "POST"
    });

    const mesaj = document.getElementById("mesaj");

    if (response.ok) {
  const result = await response.json();
  const detay = result.ceza > 0
    ? ` ${result.gecikmeGun} gün gecikme var. Ceza: ${result.ceza} ₺`
    : "Araç zamanında iade edildi.";

  mesaj.innerText = "İade başarılı! " + detay;
  mesaj.className = "text-success";
  kiralamalariGetir();
}

    } else {
      const hata = await response.text();
      mesaj.innerText = "Hata: " + hata;
      mesaj.className = "text-danger";
    }
  }
</script>

</body>
</html>
